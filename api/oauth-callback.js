
// –§–∞–π–ª: /api/oauth-callback.js
// –≠—Ç–æ—Ç endpoint –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ OAuth 2.0 –æ—Ç –ë–∏—Ç—Ä–∏–∫—Å24.
// –û–Ω –î–û–õ–ñ–ï–ù –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS (Vercel –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç—Ç–æ).

export default async function handler(req, res) {
  // 1. –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  console.log('üîê [OAuth Callback] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å:', req.method, req.query);

  // 2. –ë–∏—Ç—Ä–∏–∫—Å24 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–µ—Ç–æ–¥–æ–º GET —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ URL
  if (req.method === 'GET') {
    const { code, domain } = req.query;

    if (!code || !domain) {
      console.error('‚ùå [OAuth Callback] –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç code –∏–ª–∏ domain');
      return res.status(400).send('Invalid request: missing parameters');
    }

    try {
      // 3. –û–±–º–µ–Ω–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–¥ (code) –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ access/refresh —Ç–æ–∫–µ–Ω—ã.
      // –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞ –Ω—É–∂–µ–Ω "client_secret" –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
      // –ù–∞ —ç—Ç–∞–ø–µ —Ç–µ—Å—Ç–∞ –º—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–¥.
      // –ü–æ–ª–Ω—ã–π –æ–±–º–µ–Ω —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ POST-–∑–∞–ø—Ä–æ—Å–∞ –∫ API –ë–∏—Ç—Ä–∏–∫—Å24.
      
      console.log(`‚úÖ [OAuth Callback] –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞ ${domain}`);

      // 4. –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω –∏ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.
      // 5. –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± —É—Å–ø–µ—Ö–µ.
      // –ë–∏—Ç—Ä–∏–∫—Å24 –æ—Ç–∫—Ä–æ–µ—Ç –µ—ë –≤ iframe. –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç, —á—Ç–æ —Å–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç.
      const successHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</title>
            <meta charset="utf-8">
            <style>body { font-family: sans-serif; padding: 20px; }</style>
        </head>
        <body>
            <h2>üéâ OAuth-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç!</h2>
            <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –æ—Ç –≤–∞—à–µ–≥–æ –ë–∏—Ç—Ä–∏–∫—Å24.</p>
            <p>–ù–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ —ç—Ç–æ—Ç –∫–æ–¥ –±—É–¥–µ—Ç –æ–±–º–µ–Ω—è–Ω –Ω–∞ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API.</p>
            <p><strong>–î–æ–º–µ–Ω:</strong> ${domain}</p>
            <p><small>–ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç—É –≤–∫–ª–∞–¥–∫—É –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</small></p>
        </body>
        </html>
      `;
      return res.status(200).send(successHtml);

    } catch (error) {
      console.error('‚ùå [OAuth Callback] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      return res.status(500).send('Internal Server Error');
    }
  }

  // 6. –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ GET
  res.setHeader('Allow', ['GET']);
  return res.status(405).send(`Method ${req.method} Not Allowed`);
}
